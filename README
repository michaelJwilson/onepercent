##  Visible tiles:   https://portal.nersc.gov/project/desi/users/sjbailey/tilepicker/ci-tiles.html
##  BOSS footprint:  http://www.sdss3.org/dr9/algorithms/boss_tiling.php#footprint

##  Generate tiles file for 1%. 
py/gen_destiles.py

##  Copy targets & truth for bright & dark to run/targets.
##  Limit these files inplace to just SGC with py/gen_targets.

addrepo desisim;  addrepo desisurvey;  addrepo surveysim; addrepo desitarget; addrepo LSS; addrepo desiutil

surveyinit --config-file /global/homes/m/mjwilson/desi/survey-validation/svdc-spring2020b-onepercent/config.yaml
           --tiles-file /global/cscratch1/sd/mjwilson/svdc-spring2020b-onepercent/survey/tiles/des.fits
	   --output-path /global/cscratch1/sd/mjwilson/svdc-spring2020b-onepercent/survey/

surveysim --config-file /global/homes/m/mjwilson/desi/survey-validation/svdc-spring2020b-onepercent/config.yaml
          --tiles-file /global/cscratch1/sd/mjwilson/svdc-spring2020b-onepercent/survey/tiles/des.fits
	  --output-path /global/cscratch1/sd/mjwilson/svdc-spring2020b-onepercent/survey/
	  --rules /global/homes/m/mjwilson/desi/survey-validation/svdc-spring2020b-onepercent/rules/rules-onepercent-south.yaml
	  --debug

export PYTHONPATH=/global/homes/m/mjwilson/desi/survey-validation/svdc-spring2020f-onepercent/mcfit/:$PYTHONPATH

##  Write .fits extracted from surveysim to txt for quicksurvey. 
py/write_nights.py

##
export E2EDIR=/global/homes/m/mjwilson/desi/survey-validation/svdc-spring2020f-onepercent/

srun -A desi -N 6 -n 46 -c 8 -C haswell -t 01:00:00 --qos interactive mpi_select_mock_targets --output_dir

srun -N 6 -n 46 -c 8 mpi_select_mock_targets --output_dir /global/homes/m/mjwilson/desi/survey-validation/svdc-spring2020f-onepercent/run/targets/ --nside 64 --config desitarget/py/desitarget/mock/data/select-mock-targets-no-contam.yaml --no-spectra --nproc 4 --healpixels 17399 17404 17405 17406 17407 17975 17979 17980 17981 17982 17983 17991 17995 17996 17997 17998 17999 18000 18001 18002 18003 18004 18006 18007 18008 18009 18010 18011 18012 18013 18014 18015 18016 18017 18018 18019 18020 18021 18022 18023 18024 18025 18026 18027 18028 18029 18030 18031 18032 18033 18034 18035 18036 18037 18038 18039 18040 18041 18042 18043 18044 18045 18046 18047 18055 18059 18060 18061 18062 18063 18064 18065 18066 18067 18068 18069 18070 18071 18072 18073 18074 18075 18076 18077 18078 18079 18080 18081 18082 18083 18084 18085 18086 18087 18088 18089 18090 18091 18092 18093 18094 18095 18096 18097 18098 18099 18100 18101 18102 18103 18104 18105 18106 18107 18108 18109 18110 18111 18112 18113 18114 18115 18116 18117 18118 18119 18120 18121 18122 18123 18124 18125 18126 18127 18128 18129 18130 18131 18132 18133 18134 18135 18136 18137 18138 18139 18140 18141 18142 18143 18144 18145 18146 18147 18148 18149 18150 18151 18152 18153 18154 18155 18156 18157 18158 18159 18160 18161 18162 18163 18184 18185 18186 18187 18190 18208 18209 18210 18211 18212 18214 18215 18216 18217 18218 18219 18220 18221 18222 18223 18304 18305 18306 18307 18308 18772 18773 18775 19456 19457 19458 19459 19460 19461 19462 19463 19465 19467 19468 19469 19470 19471 19472 19473 19474 19475 19476 19477 19478 19479 19480 19481 19482 19483 19484 19485 19486 19487 19492 19493 19494 19495 19504 19505 19506 19507 19520 19521 19522 19523

select_mock_targets --output_dir /global/homes/m/mjwilson/desi/survey-validation/svdc-spring2020f-onepercent/run/targets/ --nside 64 --config desitarget/py/desitarget/mock/data/select-mock-targets-no-con\
tam.yaml --no-spectra --nproc 4 --healpixels 18063 18064 18065 18066 18067 18068 18069 18070 18071 18072 18073 18074 18075 18076 18077 18078 18079 18080 18081 18082 18083 18084 18085 18086 18087 18088 18089 18090 18091 18092 18093 18094 18095 18096 18097 18098 18099 18100 18101 18102 18103 18104 18105 18106 18107 18108 18109 18110 18111 18112 18113 18114 18115 18116 18117 18118 18119 18120 18121 18122 18123 18124 18125 18126 18127 18128 18129 18130 18131 18132 18133 18134 18135 18136 18137 18138

select_mock_targets --output_dir /global/homes/m/mjwilson/desi/survey-validation/svdc-spring2020f-onepercent/run/targets/ --nside 64 --config desitarget/py/desitarget/mock/data/select-mock-targets-no-con\
tam.yaml --no-spectra --nproc 4 --healpixels 18139 18140 18141 18142 18143 18144 18145 18146 18147 18148 18149 18150 18151 18152 18153 18154 18155 18156 18157 18158 18159 18160 18161 18162 18163 18184 18185 18186 18187 18190 18208 18209 18210 18211 18212 18214 18215 18216 18217 18218 18219 18220 18221 18222 18223 18304 18305 18306 18307 18308 18772 18773 18775 19456 19457 19458 19459 19460 19461 19462 19463 19465 19467 19468 19469 19470 19471 19472 19473 19474 19475 19476 19477 19478 19479 19480 19481 19482 19483 19484 19485 19486 19487 19492 19493 19494 19495 19504 19505 19506 19507 19520 19521 19522 19523

join_mock_targets --mockdir $E2EDIR/run/targets --overwrite

quicksurvey --fiberassign /global/common/software/desi/cori/desiconda/20190804-1.3.0-spec/code/fiberassign/master/bin/fiberassign --exposures /global/cscratch1/sd/mjwilson/svdc-spring2020f-onepercent/survey/complete_exposures_surveysim_fix.fits --fiberassignlog $E2EDIR/run/survey/assign_dates_surveysim.fits --targets_dir /global/cscratch1/sd/mjwilson/svdc-spring2020f-onepercent/targets --output_dir $E2EDIR/run/quicksurvey --footprint $E2EDIR/run/survey/tiles/des.fits

##  Patch assign dates. 
../run/survey/assign_dates_surveysim.fits


----   NOTES  ----

IO limited.  Restrict size of skies to fiberassign.

Targets & Truth limited to observed tiles in (this) quicksurvey. 


----  FIX ME ----

--  Only the first pass in gray, dark and bright should default assign date to the first day.
